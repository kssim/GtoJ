<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Grid date to json</title>
    <link rel="stylesheet" href="/lib/css/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="/lib/css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
    <link rel="stylesheet" href="/lib/css/examples.css" type="text/css"/>
    <style>
        .cell-title {
            font-weight: bold;
        }

        .cell-effort-driven {
            text-align: center;
        }
    </style>
</head>
<body>
<br>
<br>
<div style="position:relative">
    <form action="/save_data/" method="post" id="save_form_data">
        <div style="width:620px;">
            <div id="myGrid" style="width:100%;height:550px;"></div>
        </div>

        <div class="options-panel">
            <h2>Simple translater(Grid to Json)</h2>
            <ul>
                <li>It's simple translater for grid date to json.</li>
                <li>Input a data in grid, and then press the 'save' button</li>
                <li>When the save is complete, you can show data in the db.</li>
            </ul>
            &nbsp;&nbsp;&nbsp;
            <button type="submit" name="save">save</button>
        </div>
    </form>
</div>


<script src="/lib/js/jquery-1.7.min.js"></script>
<script src="/lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script src="/lib/js/jquery.event.drag-2.2.js"></script>
<script src="/lib/js/firebugx.js"></script>
<script src="/lib/js/slick.core.js"></script>
<script src="/lib/js/slick.cellrangedecorator.js"></script>
<script src="/lib/js/slick.cellrangeselector.js"></script>
<script src="/lib/js/slick.cellselectionmodel.js"></script>
<script src="/lib/js/slick.formatters.js"></script>
<script src="/lib/js/slick.editors.js"></script>
<script src="/lib/js/slick.grid.js"></script>

<script>
    function requiredFieldValidator(value) {
        if (value == null || value == undefined || !value.length) {
            return {valid: false, msg: "This is a required field"};
        } else {
            return {valid: true, msg: null};
        }
    }

    var grid;
    var data = [];
    var columns = [
        {id: "index", name: "Index", field: "index", width: 80, cssClass: "cell-title", editor: Slick.Editors.Text, validator: requiredFieldValidator},
        {id: "sequence", name: "Sequence", field: "sequence", width: 80, editor: Slick.Editors.Text},
        {id: "direction", name: "Direction", field: "direction", width: 80, editor: Slick.Editors.Text},
        {id: "flag", name: "Flag", field: "flag", width: 80, editor: Slick.Editors.Text},
        {id: "desc", name: "Description", field: "desc", width: 280, editor: Slick.Editors.LongText},
    ];

    var options = {
        editable: true,
        enableAddRow: true,
        enableCellNavigation: true,
        asyncEditorLoading: false,
        autoEdit: false
    };

    $(function () {
        for (var i = 0; i < 20; i++) {
            var d = (data[i] = {});
            d["index"] = i;
            d["sequence"] = "";
            d["direction"] = "";
            d["flag"] = "";
            d["desc"] = "";
        }
        grid = new Slick.Grid("#myGrid", data, columns, options);
        grid.setSelectionModel(new Slick.CellSelectionModel());
        grid.onAddNewRow.subscribe(function (e, args) {
            var item = args.item;
            grid.invalidateRow(data.length);
            data.push(item);
            grid.updateRowCount();
            grid.render();
        });

        grid.onCurrentCellChanged = function(args){
            data[args.row][grid.getColumns()[args.cell].field]
        };
    })


    $('#save_form_data').on('submit', function(event) {
        event.preventDefault();
        getting_data();
        save_data();
    });

    var savedData = {};
    function getting_data() {
        for (var i = 0; i<grid.getDataLength(); i++) {
            if (grid.getDataItem(i).sequence == '') {
                continue;
            }

            var d = (savedData[i] = {});
            d["index"] = grid.getDataItem(i).index;
            d["sequence"] = grid.getDataItem(i).sequence;
            d["direction"] = grid.getDataItem(i).direction;
            d["flag"] = grid.getDataItem(i).flag;
            d["desc"] = grid.getDataItem(i).desc;
        }
    }

    function save_data() {
        $.ajax({
            url : "api/data/",
            type : "POST",
            dataType : "json",
            data : { name : "test",
                data_list : JSON.stringify(savedData)
            },
            success : function() {
                alert( "Success" )
            }
        })
    }
</script>
</body>
</html>
